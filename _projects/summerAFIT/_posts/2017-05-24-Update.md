---
title: "Covariance Estimation With Switchable Constraints  "
layout: post
date: "2017-05-24"
author: Ryan Watson 
tags:
  - summerAFIT
  - covariance
  - switchable constraints
---

## Switchable Constraints 

From the tests ran yesterday on covariance estimation using M-estimators, it was verified that the M-estimators do not substantially modify the covariance of the state estimate. Continuing alone this line, today the ability of switchable constraints to correctly weight the covariance will be tested.   

### What are switchable constraints 

Switch constraints were introduced by [Niko Suenderhauf](https://wiki.qut.edu.au/display/cyphy/Niko+Suenderhauf) as a means to allow the graph to optimize it's topology --- the optimial topology is a graph consisting of only inliers --- along with the desired states. This is depicted visually below, where the factor graph shown in Figure 1 contains one false loop closure constraint. This false constraint is removed using a switchable constraint in Figure 2 ( [credit both images](http://www.qucosa.de/fileadmin/data/qucosa/documents/8644/Dissertation_Niko_Suenderhauf.pdf) ) .  


<p align="center">
<a href="https://lh3.googleusercontent.com/TLkQzY4qvbyVm9RDjQ5i4Mkeh8QKT7kT_CIObkHTZE3dlEqaV7Okyc83eHx10ndDwd7h-aMYjclEchhGYezRsWhLVbn1dBcDdekmptHPjHPz83US66Tia0pq_XUGxIPmrRZtYNKnXd3S0rJ_AYBNYFWs8CncvKXRVGwFs7uIU2wUkJo1HqKXlqedQo92Gz4d6m34L30QlDQDZW3tW5QqC1O81M5fU91-iCB4o4Dm3MjF4eMp3NpO7B1g3yBsGX4O9u_hNaEdU_7kbxBYh_HZQqC3ZJQXEI8isNYn5eOld-5Gz6GfnyJpC9nDwBbQEZ75v9dPlkCtLzHWGnQfi0ZisDWnkk79U_7nw76n6r7Eshss0m1wa1rW0Hi2JErZ1VlGtQCdWSGM8-IZYJlfKqAekvQU4ZPAXjUMsItXJlswZlkAvFg2wcazPeTAHt6OUaRA4Q4cAKTdGMUP8uGyLioVbkAdC69vjF14eg1SngoJHNcCUQ_ZhnJeIFldE7WsDraM-LICK_Ue3sURkl4s2LA3Fat8oozzD7GH30Km9BT9AtzVdz2l78rztdyVS27Z4l61ThoL7BkSZbEueKD1edn637fMF3zm8k_kCLZtxtu9jha3KkHn5LBR=w454-h62-no" target="_blank"><img src="https://lh3.googleusercontent.com/TLkQzY4qvbyVm9RDjQ5i4Mkeh8QKT7kT_CIObkHTZE3dlEqaV7Okyc83eHx10ndDwd7h-aMYjclEchhGYezRsWhLVbn1dBcDdekmptHPjHPz83US66Tia0pq_XUGxIPmrRZtYNKnXd3S0rJ_AYBNYFWs8CncvKXRVGwFs7uIU2wUkJo1HqKXlqedQo92Gz4d6m34L30QlDQDZW3tW5QqC1O81M5fU91-iCB4o4Dm3MjF4eMp3NpO7B1g3yBsGX4O9u_hNaEdU_7kbxBYh_HZQqC3ZJQXEI8isNYn5eOld-5Gz6GfnyJpC9nDwBbQEZ75v9dPlkCtLzHWGnQfi0ZisDWnkk79U_7nw76n6r7Eshss0m1wa1rW0Hi2JErZ1VlGtQCdWSGM8-IZYJlfKqAekvQU4ZPAXjUMsItXJlswZlkAvFg2wcazPeTAHt6OUaRA4Q4cAKTdGMUP8uGyLioVbkAdC69vjF14eg1SngoJHNcCUQ_ZhnJeIFldE7WsDraM-LICK_Ue3sURkl4s2LA3Fat8oozzD7GH30Km9BT9AtzVdz2l78rztdyVS27Z4l61ThoL7BkSZbEueKD1edn637fMF3zm8k_kCLZtxtu9jha3KkHn5LBR=w454-h62-no" border="0" alt="graph1 photo graph1_zps5ip2jvfx.png"/></a>
</p>
<p align="center">
Fig 1 :: Inital Graph Containing False Constraint. 
</p>
<br>


<p align="center">
<a href="https://lh3.googleusercontent.com/T-BGKbGcVbVVtUFV3RBsCFogE_UM0wJXn2pS6Asr8J4cQRXAvnl_lok_p4JDceKQW-qwQvxWUnsNXxAEsj8_Wrw7ChYUhVIKowTNjXqev44zCw2zDgP_Ay2NDbdBTwB_oO1BX5NSMic1kEmMRlW3rpSMeMqf9yca2DQR_040dX71X4-XukIb9hru6eEG7LZkGVLDOOxDIFKLW025qnKo8OofnV0LHcfFL8BR8-a52Apgv7KUiwAn0Hw53w4ZDAfDWnVsPE3VCPgAauysInWniK6RoUTR02msnlmQsXuyUOcnd07KY0euFuRbuqjCjZYiY93saUQv9ZaKh6GGuf1H7RTnJnwwkxDUgvRQy0Qhn0qfp5APcWBtjusO8VtDeuCHikm9NGy_D1a271POqikzKgdjFdSVhX9LLpPXP-1Gm8OyzBj9ITN4I9-rYFRwQPbrDOhGz_SaLRVQONjd0wROdoFlgnyJTzNbCtAbje9alyzkFxNGfqBjS7g9TA8q9RrLHylYtIDt01w8y1lNeca4jMhenCAPEjsD1II3idY85_wBktmdEh3ZwqAXcccLjb1bWcrleR8_xZQ5cPC-9ONMtAiq4MBu2kTppvwMFo20FCrqg8znMMjM=w445-h134-no" target="_blank"><img src="https://lh3.googleusercontent.com/T-BGKbGcVbVVtUFV3RBsCFogE_UM0wJXn2pS6Asr8J4cQRXAvnl_lok_p4JDceKQW-qwQvxWUnsNXxAEsj8_Wrw7ChYUhVIKowTNjXqev44zCw2zDgP_Ay2NDbdBTwB_oO1BX5NSMic1kEmMRlW3rpSMeMqf9yca2DQR_040dX71X4-XukIb9hru6eEG7LZkGVLDOOxDIFKLW025qnKo8OofnV0LHcfFL8BR8-a52Apgv7KUiwAn0Hw53w4ZDAfDWnVsPE3VCPgAauysInWniK6RoUTR02msnlmQsXuyUOcnd07KY0euFuRbuqjCjZYiY93saUQv9ZaKh6GGuf1H7RTnJnwwkxDUgvRQy0Qhn0qfp5APcWBtjusO8VtDeuCHikm9NGy_D1a271POqikzKgdjFdSVhX9LLpPXP-1Gm8OyzBj9ITN4I9-rYFRwQPbrDOhGz_SaLRVQONjd0wROdoFlgnyJTzNbCtAbje9alyzkFxNGfqBjS7g9TA8q9RrLHylYtIDt01w8y1lNeca4jMhenCAPEjsD1II3idY85_wBktmdEh3ZwqAXcccLjb1bWcrleR8_xZQ5cPC-9ONMtAiq4MBu2kTppvwMFo20FCrqg8znMMjM=w445-h134-no"/></a>
</p>
<p align="center">
Fig 2 :: Graph with Switch Constraint Applied to False Loop 
</p>
<br>


More formally, the initial graphs optimization function is 

$$ X^* = argmin \sum_i || \mathcal{f}(x_i,u_i) - x_{i+1} ||_{\Sigma_i}^2 + \sum_{ij} || \mathcal{f}(x_i,u_{ij}) - x_j ||_{\Lambda_{ij}}^2 , $$

where $x_i$ is the state vector, $u_i$ is the control input, $u_{ij}$ is the loop closure displacement between $x_i$ and $x_j$, and $\Sigma$ and $\Lambda$ are covariance matrices. This optimization can be augmented with switchable constraints such that the new objective function becomes 


$$ X^*,S^* = argmin \sum_i || \mathcal{f}(x_i,u_i) - x_{i+1} ||_{\Sigma_i}^2 + \sum_{ij} || \psi(s_{ij}) (\mathcal{f}(x_i,u_{ij}) - x_j) ||_{\Lambda_{ij}}^2  + \sum_{ij} || \gamma_{ij} - s_{ij} ||_{\Xi}^{2}, $$


where $s_{ij}$ is the switch variable being estimated, $\gamma_{ij}$ is the inital estimate of the switch variable ( generally this is set to 1 ), and $\psi()$ is a real-valued function s.t. $\psi(s_{ij}) = w_{ij} : \mathcal{R} \rightarrow \[ 1,0 \]$ ( in [Suenderhauf's Thesis](http://www.qucosa.de/fileadmin/data/qucosa/documents/8644/Dissertation_Niko_Suenderhauf.pdf), a simple linear function is recommended )


### How Switch Constraints Modify the Covariance Matrix 


We can evaluate the affect that switchable constraints will have on the covariance estimate by analyzing the modified loop closure constraint

$$ || \psi(s_{ij}) (\mathcal{f}(x_i,u_{ij}) - x_j) ||_{\Lambda_{ij}}^2 = (w_{ij}\delta_{ij})^T \Lambda^{-1}_{ij}  (w_{ij}\delta_{ij}), $$ 


where $\delta_{ij} \triangleq \mathcal{f}(x_i,u_{ij} - x_j)$ and $w_{ij} \triangleq \psi(s_{ij})$ 

Then, by noting that $w_{ij}$ is a scalar, we can re-arrange the equation above to

$$ || \psi(s_{ij}) (\mathcal{f}(x_i,u_{ij}) - x_j) ||_{\Lambda_{ij}}^2 = \delta_{ij}^T [ w_{ij}^2 \Lambda_{ij}^{-1}]\delta_{ij}. $$ 


This shows us that the estimated weight directly influences the information matrix, as shown below, 

$$ w^2_{ij} \Lambda_{ij}^{-1} = \Phi_{ij}^{-1}. $$

And the associated covariance matrix is 

$$ \Phi_{ij} = (\Phi_{ij}^{-1})^{-1} = ( w_{ij}^2 \Lambda_{ij}^{-1} )^{-1} = \frac{1}{w^2} \Lambda_{ij}. $$


In this light, switchable constraints can be see as an adaptive M-estimator.


### Compiling Switchable Constraints with GTSAM4 and Ubuntu 16.04

The initial switchable constraints library written by Niko was designed for GTSAM2. Currently we're on GTSAM4, so several modification had to be made to his source code. You can pull down the updated code from my github repo using the line below.

```bash 

$ git clone https://github.com/watsonryan/vertigo.git

```


### Testing Switch Factors 

To test switch factors, we use the same graph that all previous test were conducted with. For reference, the solution using the $L_2$ cost function is shown below. This plot shows the solution with and without a false constraint linking the fifth vertex to the second vertex. Note that the solution is substantially worse when the fault is present; however, the optimizers uncertainty in the solution is essentially unchanged.


<p align='center'>
<a href="https://lh3.googleusercontent.com/-f76xg6LpNJRAPDtq6mKXngnNkNfcC5Yntm6Zq9lit1hGPKOxtIZRNsusFD4h1zp0fo3A6modVdu2OAN5pweNmoM1IsVnyNwGv2t2YLH8e5O9QleMC98VvJ3OesqIIBB_TCgATyaNVT0aVAaV67Jfi07TuLDCLLqJCXXzdKBMFjQoiCjmLJCwVNzGYZR4ZxcbOPAVSfe_fLaXc0GXkcyoc5rXKwY3hVnoZNZSp5xIC4y-O0Gph7ji4CWqXpOmrYuiL7Bd_s8fw3EEVuFzOvxt5OU_06EtLTyb9QRNFocpDk1lX3h1dUkkIhSKBWkGJ9ubou9co3VSv30zgAnU5fOTAnGDDYzz3je9IIRSEBPC4ar6bP9JQC6iqUmNzWUrB47gBzxaKdMGcKz7ipMqNcV2oFk3sURFvpSUH7nrxjEWhgiyxGMzFPalDil376spARRTFVaJf1cl59MW_UnwJCXVK23XKQjLoekEjhMxFsxIfwFo1DuHi9E9rAV6YPF1pfdtFFpUJHS5TTVaB0-KzTM2Kjejy3n4Pdg7i3WxdEnxzvKTDICi8t_8LuSJRD4YL_AX9xUw-FjB7bXzEj1WeirC_ekvToeOFTHB0W2KJDOGYrR3g0u1ROH=w1024-h538-no" target="_blank"><img src="https://lh3.googleusercontent.com/-f76xg6LpNJRAPDtq6mKXngnNkNfcC5Yntm6Zq9lit1hGPKOxtIZRNsusFD4h1zp0fo3A6modVdu2OAN5pweNmoM1IsVnyNwGv2t2YLH8e5O9QleMC98VvJ3OesqIIBB_TCgATyaNVT0aVAaV67Jfi07TuLDCLLqJCXXzdKBMFjQoiCjmLJCwVNzGYZR4ZxcbOPAVSfe_fLaXc0GXkcyoc5rXKwY3hVnoZNZSp5xIC4y-O0Gph7ji4CWqXpOmrYuiL7Bd_s8fw3EEVuFzOvxt5OU_06EtLTyb9QRNFocpDk1lX3h1dUkkIhSKBWkGJ9ubou9co3VSv30zgAnU5fOTAnGDDYzz3je9IIRSEBPC4ar6bP9JQC6iqUmNzWUrB47gBzxaKdMGcKz7ipMqNcV2oFk3sURFvpSUH7nrxjEWhgiyxGMzFPalDil376spARRTFVaJf1cl59MW_UnwJCXVK23XKQjLoekEjhMxFsxIfwFo1DuHi9E9rAV6YPF1pfdtFFpUJHS5TTVaB0-KzTM2Kjejy3n4Pdg7i3WxdEnxzvKTDICi8t_8LuSJRD4YL_AX9xUw-FjB7bXzEj1WeirC_ekvToeOFTHB0W2KJDOGYrR3g0u1ROH=w1024-h538-no" border="0" alt="L2Comp photo l2Comp_zpsoangtvs6.png"/></a>
</p>
<p align='center'>
Fig 3 :: Graph Optimization using $L_2$ 
</p>


Now, we add switchable constraints to the faulty graph to see how well it can handle erroneous data. As a comparison, the switch factor optimization on the faulty graph is compared to the solution obtained by $L_2$ optimization on the fault free graph. As can be seen in the Figure below, the positioning solutions from the two optimization routines are essentially identical; however, the switch factor optimiation conveys the additional uncertienty in the final three position nodes due to the false constraint. 


<p align='center'>
<a href="https://lh3.googleusercontent.com/53Ba5ep0e5uPVn45yfjlSITC5mlTbKvQ5MAJ0OD2gyhV8fdWpe3ZkdaihQiDrsYQw3oPHcfgp4zsr4MdsssZmzm42Dw1LFhIPDdi6RVqH_8wBepdpLDlep69DVk426uoLJ8VysH-O-MLUR5TmeYLImQ06gEThzBxk4K0Gn4sHUw3_x_9fc4V-bBUO_WjyRCfeBJnk4dX7hg7ZYWxptBnc-ZL0imoKTHmsPTecYHf1XFxshJ-lhIl3mVZ4b59ZLraJSFsXuomz268kxfauKZFWsr0vA0X3B7yoNZAAjdhuL9o0jiNikT9f-pvdgEL-XvxHM3lUHX3_ikdjkvOHWSSCxlQUKhZ58rRAJds8BPAQX6cgcsM6cbC-DmANclb7A5P_WN5RD5aKUtcYvAxScSyTMkvawjQsifDJFHuYqDJJfHkAD4dO3mMaiBsdsscVY38c7QfSjkYpQsz3JmpX-ghnVUon2-dn1v1RIZ43vHBz8-STAcgZ_8Fjz2jgFKcxD3GlPz5WX3jtlwxWkqtV2WuzAph2xUJtWgy20zBjryg3FckeObWo27rO8rw9nWdjRplaXDoBRITNeJ3FTaE-vagMVU4C9QMHidMKYcS0H3asevm7gsMtlwV=w1024-h538-no" target="_blank"><img src="https://lh3.googleusercontent.com/53Ba5ep0e5uPVn45yfjlSITC5mlTbKvQ5MAJ0OD2gyhV8fdWpe3ZkdaihQiDrsYQw3oPHcfgp4zsr4MdsssZmzm42Dw1LFhIPDdi6RVqH_8wBepdpLDlep69DVk426uoLJ8VysH-O-MLUR5TmeYLImQ06gEThzBxk4K0Gn4sHUw3_x_9fc4V-bBUO_WjyRCfeBJnk4dX7hg7ZYWxptBnc-ZL0imoKTHmsPTecYHf1XFxshJ-lhIl3mVZ4b59ZLraJSFsXuomz268kxfauKZFWsr0vA0X3B7yoNZAAjdhuL9o0jiNikT9f-pvdgEL-XvxHM3lUHX3_ikdjkvOHWSSCxlQUKhZ58rRAJds8BPAQX6cgcsM6cbC-DmANclb7A5P_WN5RD5aKUtcYvAxScSyTMkvawjQsifDJFHuYqDJJfHkAD4dO3mMaiBsdsscVY38c7QfSjkYpQsz3JmpX-ghnVUon2-dn1v1RIZ43vHBz8-STAcgZ_8Fjz2jgFKcxD3GlPz5WX3jtlwxWkqtV2WuzAph2xUJtWgy20zBjryg3FckeObWo27rO8rw9nWdjRplaXDoBRITNeJ3FTaE-vagMVU4C9QMHidMKYcS0H3asevm7gsMtlwV=w1024-h538-no" border="0" alt="sfComp photo sfComp_zpsdjxdxacn.png"/></a>
</p>
<p align='center'>
Fig 4 :: Switch Factor Optimization of Faulty Graph Compared to $L_2$ Optimization of Clean Graph
</p>
