---
title: "Covariance Estimation With Switchable Constraints  "
layout: post
date: "2017-05-24"
author: Ryan Watson 
tags:
  - summerAFIT
  - covariance
  - switchable constraints
---

## Switchable Constraints 

From the tests ran yesterday on covariance estimation using M-estimators, it was verified that the M-estimators do not substantially modify the covariance of the state estimate. Continuing alone this line, today the ability of switchable constraints to correctly weight the covariance will be tested.   

### What are switchable constraints 

Switch constraints were introduced by [Niko Suenderhauf](https://wiki.qut.edu.au/display/cyphy/Niko+Suenderhauf) as a means to allow the graph to optimize it's topology --- the optimial topology is a graph consisting of only inliers --- along with the desired states. This is depicted visually below, where the factor graph shown in Figure 1 contains one false loop closure constraint. This false constraint is removed using a switchable constraint in Figure 2 ( [credit both images](http://www.qucosa.de/fileadmin/data/qucosa/documents/8644/Dissertation_Niko_Suenderhauf.pdf) ) .  


<p align="center">
<a href="http://s1347.photobucket.com/user/rwatso12/media/graph1_zps5ip2jvfx.png.html" target="_blank"><img src="http://i1347.photobucket.com/albums/p701/rwatso12/graph1_zps5ip2jvfx.png" border="0" alt="graph1 photo graph1_zps5ip2jvfx.png"/></a>
</p>
<p align="center">
Fig 1 :: Inital Graph Containing False Constraint. 
</p>
<br>


<p align="center">
<a href="http://s1347.photobucket.com/user/rwatso12/media/graph2_zpsqbdqbrca.png.html" target="_blank"><img src="http://i1347.photobucket.com/albums/p701/rwatso12/graph2_zpsqbdqbrca.png" border="0" alt="graph2 photo graph2_zpsqbdqbrca.png"/></a>
</p>
<p align="center">
Fig 1 :: Graph with Switch Constraint Applied to False Loop 
</p>
<br>


More formally, the initial graphs optimization function is 

$$ X^* = argmin \sum_i || \mathcal{f}(x_i,u_i) - x_{i+1} ||_{\Sigma_i}^2 + \sum_{ij} || \mathcal{f}(x_i,u_{ij}) - x_j ||_{\Lambda_{ij}}^2 , $$

where $x_i$ is the state vector, $u_i$ is the control input, $u_{ij}$ is the loop closure displacement between $x_i$ and $x_j$, and $\Sigma$ and $\Lambda$ are covariance matrices. This optimization can be augmented with switchable constraints such that the new objective function becomes 


$$ X^*,S^* = argmin \sum_i || \mathcal{f}(x_i,u_i) - x_{i+1} ||_{\Sigma_i}^2 + \sum_{ij} || \psi(s_{ij}) (\mathcal{f}(x_i,u_{ij}) - x_j) ||_{\Lambda_{ij}}^2  + \sum_{ij} || \gamma_{ij} - s_{ij} ||_{\Xi}^{2}, $$


where $s_{ij}$ is the switch variable being estimated, $\gamma_{ij}$ is the inital estimate of the switch variable ( generally this is set to 1 ), and $\psi()$ is a real-valued function s.t. $\psi(s_{ij}) = w_{ij} : \mathcal{R} \rightarrow \[ 1,0 \]$ ( in [Suenderhauf's Thesis](http://www.qucosa.de/fileadmin/data/qucosa/documents/8644/Dissertation_Niko_Suenderhauf.pdf), a simple linear function is recommended )


### How Switch Constraints Modify the Covariance Matrix 


We can evaluate the affect that switchable constraints will have on the covariance estimate by analyzing the modified loop closure constraint

$$ || \psi(s_{ij}) (\mathcal{f}(x_i,u_{ij}) - x_j) ||_{\Lambda_{ij}}^2 = (w_{ij}\delta_{ij})^T \Lambda^{-1}_{ij}  (w_{ij}\delta_{ij}), $$ 


where $\delta_{ij} \triangleq \mathcal{f}(x_i,u_{ij} - x_j)$ and $w_{ij} \triangleq \psi(s_{ij})$ 

Then, by noting that $w_{ij}$ is a scalar, we can re-arrange the equation above to

$$ || \psi(s_{ij}) (\mathcal{f}(x_i,u_{ij}) - x_j) ||_{\Lambda_{ij}}^2 = \delta_{ij}^T [ w_{ij}^2 \Lambda_{ij}^{-1}]\delta_{ij}. $$ 


This shows us that the estimated weight directly influences the information matrix, as shown below, 

$$ w^2_{ij} \Lambda_{ij}^{-1} = \Phi_{ij}^{-1}. $$

And the associated covariance matrix is 

$$ \Phi_{ij} = (\Phi_{ij}^{-1})^{-1} = ( w_{ij}^2 \Lambda_{ij}^{-1} )^{-1} = \frac{1}{w^2} \Lambda_{ij}. $$


In this light, switchable constraints can be see as an adaptive M-estimator.


### Compiling Switchable Constraints with GTSAM4 and Ubuntu 16.04

The initial switchable constraints library written by Niko was designed for GTSAM2. Currently we're on GTSAM4, so several small modification had to be made to his source code. You can pull down the updated code from my github repo using the line below.

```bash 

$ git clone https://github.com/watsonryan/vertigo.git

```
